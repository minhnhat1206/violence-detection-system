# =========================
# Spark Core
# =========================
spark.master                                spark://spark-master:7077
spark.app.name                              ViolenceDetectionPipeline
spark.submit.deployMode                     client
spark.serializer                            org.apache.spark.serializer.KryoSerializer

# =========================
# Resource Management 
# =========================
spark.driver.memory                         3g
spark.executor.memory                       4g
spark.executor.memoryOverhead               1024m 

spark.executor.cores                        2
spark.cores.max                             2

# =========================
# Memory/Performance (Tối ưu hóa chống Spill)
# =========================
# Phân bổ bộ nhớ Spark (ưu tiên Execution)
spark.memory.fraction                       0.8
spark.memory.storageFraction                0.3

spark.sql.shuffle.partitions                4
spark.default.parallelism                   4

# =========================
# Logging & Stability
# =========================
spark.eventLog.enabled                      true
spark.eventLog.dir                          file:///opt/bitnami/spark/events
spark.sql.streaming.forceDeleteTempCheckpointLocation true
spark.streaming.stopGracefullyOnShutdown    true
spark.network.timeout                       800s
spark.executor.heartbeatInterval            60s
spark.rpc.message.maxSize                   256
spark.sql.broadcastTimeout                  3600
spark.sql.parquet.compression.codec         snappy


# =========================
# Iceberg & Catalog
# =========================
spark.sql.extensions                        org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions
spark.sql.catalog.iceberg                   org.apache.iceberg.spark.SparkCatalog
spark.sql.catalog.iceberg.type              hive
spark.sql.catalog.iceberg.uri               thrift://hive-metastore:9083
spark.sql.catalog.iceberg.warehouse         s3a://warehouse/iceberg_warehouse/

# =========================
# S3A / MinIO (Tối ưu I/O)
# =========================
spark.hadoop.fs.s3a.impl                      org.apache.hadoop.fs.s3a.S3AFileSystem
spark.hadoop.fs.s3a.endpoint                  http://minio:9000
spark.hadoop.fs.s3a.access.key                minio
spark.hadoop.fs.s3a.secret.key                mypassword
spark.hadoop.fs.s3a.path.style.access         true
spark.hadoop.fs.s3a.connection.ssl.enabled    false
spark.hadoop.fs.s3a.aws.credentials.provider  org.apache.hadoop.fs.s3a.SimpleAWSCredentialsProvider
# Bổ sung committer an toàn và hiệu quả
spark.hadoop.fs.s3a.committer.name            directory
spark.hadoop.mapreduce.fileoutputcommitter.algorithm.version 2
# Đảm bảo băng thông S3A đủ lớn
spark.hadoop.fs.s3a.threads.max               32


# =========================
# REQUIRED JARS 
# =========================
spark.jars.packages \
org.apache.spark:spark-sql-kafka-0-10_2.12:3.3.4,\
org.apache.hadoop:hadoop-aws:3.3.4,\
org.apache.iceberg:iceberg-spark-runtime-3.3_2.12:1.3.1